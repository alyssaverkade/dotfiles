#!/usr/bin/env bash

set -e


if [[ $# -eq 0 ]]; then
  AWS_PROFILE="$(aws-profiles)"
else
  AWS_PROFILE="$1"
fi

if [[ -n "$2" ]]; then
  ECS_CLUSTER="$2"
else
  ECS_CLUSTERS="$(ecs-clusters "${AWS_PROFILE}")"
  ECS_CLUSTER="$(fzy <<< "${ECS_CLUSTERS}")"
fi

if [[ -n "$3" ]]; then
  ECS_SERVICE="$3"
else
  ECS_SERVICES="$(ecs-services "${AWS_PROFILE}" "${ECS_CLUSTER}")"
  ECS_SERVICE="$(fzy <<< "${ECS_SERVICES}")"
fi

if [[ -n "$4" ]]; then
  ECS_TASK="$4"
else 
  ECS_TASKS="$(ecs-tasks "${AWS_PROFILE}" "${ECS_CLUSTER}" "${ECS_SERVICE}")"
  ECS_TASK="$(fzy <<< "${ECS_TASKS}")"
fi

RAW_ECS_CONTAINERS="$(set -x; aws ecs describe-tasks --profile "${AWS_PROFILE}" --cluster "${ECS_CLUSTER}" --tasks "${ECS_TASK}")"
ECS_CONTAINERS="$(jq -r '.tasks | .[].containers.[].name' <<< "${RAW_ECS_CONTAINERS}")"

ECS_CONTAINER="$(fzy <<< "${ECS_CONTAINERS}")"


set -x
aws ecs execute-command --profile "${AWS_PROFILE}" --cluster "${ECS_CLUSTER}" --task "${ECS_TASK}" --container "${ECS_CONTAINER}" --interactive --command "/bin/bash"


